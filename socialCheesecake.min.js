/*
 SocialCheesecake JavaScript Library v0.2.0
 https://github.com/adiezbal/SocialCheesecake
 Developed by Alicia D?ez (https://github.com/adiezbal)
 Copyright 2011, Technical University of Madrid (Universidad Polit?cnica de Madrid)
 Licensed under the MIT or GPL Version 2 licenses.
 Date: Dec 22 2011

 Copyright (C) 2011 by Technical University of Madrid (Universidad Polit?cnica de Madrid)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
*/
var socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.Actor=function(a){if(!a)throw"No arguments passed to the function";if(!a.parent)throw"Actor must be associated to at least a subsector";var b={},c;for(c in b)c in a||(a[c]=b[c]);this.id=a.id;this.name=a.name;this.extraInfo=a.extraInfo?a.extraInfo:void 0;this.opacity=1;this._selected=this._focused=!1;this._hidden=!0;this._filtered=!1;this.fading="none";this.parents=[];a.parent&&this.parents.push(a.parent);var d=this,a=d.getDiv();a.addEventListener("mouseover",function(){var a;
d.isSelected()||d.focus();for(var b in d.parents)a=d.parents[b].parent,a.focus(),a.changeColor(a.mouseover.color),d.parents[b].changeColor(d.parents[b].mouseover.color)},!1);a.addEventListener("mouseout",function(){var a;d.isSelected()||d.unfocus();for(var b in d.parents)a=d.parents[b].parent,a.unfocus(),a.changeColor(a.mouseout.color),d.parents[b].changeColor(a.mouseout.color)},!1);a.addEventListener("mousedown",function(){d.isSelected()?d.unselect():d.select()},!1)};socialCheesecake.Actor.prototype.getParentsIds=
function(){var a=this.parents,b=[],c;for(c in a)b.push(a[c].id);return b};socialCheesecake.Actor.prototype.isSelected=function(){return this._selected};socialCheesecake.Actor.prototype.select=function(){this._selected=!0;this.focus()};socialCheesecake.Actor.prototype.unselect=function(){this._selected=!1;this.unfocus()};socialCheesecake.Actor.prototype.focus=function(){var a=this.getDiv(),b="";this._focused=!0;a.getAttribute("class")?a.getAttribute("class").match(/\sfocused/)||(b=a.getAttribute("class").concat(" focused"),
a.setAttribute("class",b)):a.setAttribute("class","focused")};socialCheesecake.Actor.prototype.unfocus=function(){var a=this.getDiv(),b="";this._focused=!1;a.getAttribute("class")&&(b=a.getAttribute("class").replace(/(^|\s)focused($|\s)/,""),a.setAttribute("class",b))};socialCheesecake.Actor.prototype.isFocused=function(){this.getCheesecake();return this._focused};socialCheesecake.Actor.prototype.hide=function(){var a=this.getDiv(),b=" display: none;";this._hidden=!0;a.getAttribute("style")&&(b=a.getAttribute("style").match(/display\s*:\s*[a-z]*;/)?
a.getAttribute("style").replace(/display\s*:\s*[a-z]*;/,"display: none;"):a.getAttribute("style").concat("display: none;"));a.setAttribute("style",b);this.fading="none"};socialCheesecake.Actor.prototype.show=function(){var a=this.getDiv(),b=" display: inline;";if(!this.isFiltered())this._hidden=!1,a.getAttribute("style")&&(b=a.getAttribute("style").match(/display\s*:\s*[a-z]*;/)?a.getAttribute("style").replace(/display\s*:\s*[a-z]*;/,"display: inline;"):a.getAttribute("style").concat("display: inline;")),
a.setAttribute("style",b)};socialCheesecake.Actor.prototype.isHidden=function(){return this._hidden};socialCheesecake.Actor.prototype.isFiltered=function(){return this._filtered};socialCheesecake.Actor.prototype.isVisible=function(){return!(this.isHidden()||this.isFiltered())};socialCheesecake.Actor.prototype.filter=function(){this._filtered=!0;this.fadeOut(100,!0)};socialCheesecake.Actor.prototype.unfilter=function(){this._filtered=!1};socialCheesecake.Actor.prototype.setDivOpacity=function(a){var a=
1<a?1:a,a=0>a?0:a,b=this.getDiv();this.opacity=a;a="opacity: "+this.opacity+";";b.getAttribute("style")&&(a=b.getAttribute("style").replace(/opacity\s*:\s*[a-zA-Z0-9.]*;/g,""),a=a.concat("opacity: "+this.opacity+";"));b.setAttribute("style",a)};socialCheesecake.Actor.prototype.fade=function(a,b){var c=this,a=a?a:300,d;d=0;"out"==this.fading?d=-1:"in"==this.fading&&(d=1);d=this.opacity+d*(1E3/(60*a));d=Math.round(1E3*d)/1E3;c.setDivOpacity(d);"out"==this.fading&&0<=d||"in"==this.fading&&1>=d?requestAnimFrame(function(){c.fade(a,
b)}):(this.fading="none",b&&0>=d&&c.hide())};socialCheesecake.Actor.prototype.fadeOut=function(a,b){this.fading="out";this.setDivOpacity(1);this.fade(a,b)};socialCheesecake.Actor.prototype.fadeIn=function(a,b){if(!this.isFiltered())this.fading="in",this.setDivOpacity(0),b&&this.show(),this.fade(a,b)};socialCheesecake.Actor.prototype.getCheesecake=function(){return this.parents[0].parent.parent};socialCheesecake.Actor.prototype.getDiv=function(){var a=this.getCheesecake().grid.divIdPrefix;return document.getElementById(a+
this.id)}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.colors={normalSector:{background:"#eeffee",highlight:"#77ff77",hover:"#aaffaa",font:"#1F4A75",border:"#1F4A75"},extraSector:{background:"#e5e5e5",highlight:"#1FA0F7",hover:"#D4E4EA",font:"#1F4A75",border:"#1F4A75"},greySector:{background:"#f5f5f5",highlight:"#f5f5f5",hover:"#f5f5f5",font:"#666",border:"#666"}};var a=30;socialCheesecake.Cheesecake=function(a){var c=a.sectors,d=this;d.center={x:a.center.x,y:a.center.y};d.rMax=a.rMax;d.sectors=[];d.highlightedSector=null;
d.highlightedSectorCallback=a.highlightedSectorCallback||void 0;d.auxiliarSectors=[];d.stage=new Kinetic.Stage(a.container.id,a.container.width,a.container.height);d.stage.add(new Kinetic.Layer);d.stage.mainLayer=d.stage.layers[0];d.grid=new socialCheesecake.Grid({parent:this,grid_id:a.grid.id,divIdPrefix:a.grid.divIdPrefix||"actor_"});d.searchEngine=new socialCheesecake.SearchEngine({parent:this});d.matchActorsNumber=a.match;if(null==d.matchActorsNumber)d.matchActorsNumber=!0;d._initialState={};
d._changes={};d.onChange=function(){};void 0!=a.maxVisibleActors&&socialCheesecake.Cheesecake.setMaxVisibleActors(a.maxVisibleActors);if(a.onChange)d.onChange=a.onChange;if(a.text)for(var e in a.text)socialCheesecake.text[e]=a.text[e];if(a.colors)for(var f in a.colors)for(var g in a.colors[f])socialCheesecake.colors[f][g]=a.colors[f][g];16>c.length&&(e=new socialCheesecake.Sector({parent:d,center:{x:a.center.x,y:a.center.y},label:"+",rOut:a.rMax,color:socialCheesecake.colors.extraSector.background,
mouseover:{color:socialCheesecake.colors.extraSector.hover,callback:function(a){a.focus();d.grid.hideAll()}},mouseout:{color:socialCheesecake.colors.extraSector.background,callback:function(a){a.unfocus();d.grid.fadeInAll(300,!0)}},mouseup:{color:socialCheesecake.colors.extraSector.background},mousedown:{color:socialCheesecake.colors.extraSector.highlight},subsectors:[{name:"New Subsector 1"}],auxiliar:!0,fontColor:socialCheesecake.colors.extraSector.font,borderColor:socialCheesecake.colors.extraSector.border}),
d.sectors[c.length]=e);e=Math.min(c.length,16);for(f=0;f<e;f++)d.sectors[f]=new socialCheesecake.Sector({parent:d,center:{x:a.center.x,y:a.center.y},id:c[f].id,label:c[f].name,rOut:a.rMax,subsectors:c[f].subsectors,mouseover:{color:socialCheesecake.colors.normalSector.hover,callback:function(a){document.body.style.cursor="pointer";d.grid.hideAll();d.grid.fadeIn(a.actors,300,!0);a.focus();null!=d.highlightedSector?d.highlightedSector.fan(!1,function(){a.fan(!0)}):a.fan(!0);a.getCheesecake().setHighlightedSector(a)}},
mouseout:{color:socialCheesecake.colors.normalSector.background,callback:function(a){document.body.style.cursor="default";d.grid.hide(a.actors);d.grid.fadeInAll(300,!0);a.unfocus();a.getCheesecake().setHighlightedSector(null);a.fan(!1)}},mousedown:{color:socialCheesecake.colors.normalSector.highlight,callback:function(a){d.focusAndBlurCheesecake(a);d.grid.hideAll();d.grid.fadeIn(a.actors,300,!0)}},mouseup:{color:socialCheesecake.colors.normalSector.background},fontColor:socialCheesecake.colors.normalSector.font,
borderColor:socialCheesecake.colors.normalSector.border});d.calculatePortions();d._setInitialState();d.draw()};socialCheesecake.Cheesecake.prototype.draw=function(){var a=this.sectors,c=this.stage.mainLayer,d;for(d in a)c.add(a[d].getRegion());this.stage.draw()};socialCheesecake.Cheesecake.prototype.disable=function(){var a=this.stage.layers,c;for(c in a)a[c].listen(!1)};socialCheesecake.Cheesecake.prototype.enable=function(){var a=this.stage.layers,c;for(c in a)a[c].listen(!0)};socialCheesecake.Cheesecake.prototype.focusAndBlurCheesecake=
function(a){var c=this,d=this.stage.mainLayer,e=d.getShapes(),f,g;for(g in c.sectors)c.sectors[g]===a&&(f=g);if(null==f)throw"sector doesn't belong to this cheesecake";for(g=e.length-1;0<=g;g--)e[g].permanent||d.remove(e[g]);d.clear();this.setHighlightedSector(a);var e={parent:c,center:{x:c.center.x,y:c.center.y},phi:a.phi,delta:a.delta,rOut:a.rOut,label:a.label,simulate:f,mouseout:{callback:function(){document.body.style.cursor="default"}},mouseover:{callback:function(){document.body.style.cursor=
"pointer"}},auxiliar:!0},h=new socialCheesecake.Sector({parent:c,center:{x:c.center.x,y:c.center.y},phi:a.phi+a.delta,delta:2*Math.PI-a.delta,rOut:c.rMax,mouseout:{color:socialCheesecake.colors.greySector.background,callback:function(){document.body.style.cursor="default"}},mousedown:{color:socialCheesecake.colors.greySector.highlight},mouseup:{color:socialCheesecake.colors.greySector.background},mouseover:{color:socialCheesecake.colors.greySector.hover,callback:function(){document.body.style.cursor=
"pointer"}},color:socialCheesecake.colors.greySector.background,fontColor:socialCheesecake.colors.greySector.font,borderColor:socialCheesecake.colors.greySector.border,auxiliar:!0});c.auxiliarSectors.push(h);var i=new socialCheesecake.Sector(e);c.auxiliarSectors.push(i);d.add(h.getRegion());d.add(i.getRegion());var l=function(){h.label="";c.unfocusAndUnblurCheesecake()},j=function(){h.mousedown.callback=l;h.label="GO BACK"},k=function(){i.splitUp()};h.rotateTo({destination:5*Math.PI/4,callback:function(){h.resizeDelta({delta:3*
Math.PI/2,anchor:"M",callback:j})},anchor:"M"});i.rotateTo({destination:Math.PI/4,callback:function(){i.resizeDelta({anchor:"M",callback:k})},anchor:"M"})};socialCheesecake.Cheesecake.prototype.recoverCheesecake=function(){for(var a=this.highlightedSector,c=this.stage.mainLayer,d=c.getShapes(),e=d.length-1;0<=e;e--)d[e].permanent||(c.remove(d[e]),this.auxiliarSectors.pop());c.clear();this.draw();if(a)a.color=a.originalAttr.color,a.fan(!1),a.unfocus(),this.setHighlightedSector(null);this.grid.fadeInAll(300,
!0)};socialCheesecake.Cheesecake.prototype.unfocusAndUnblurCheesecake=function(){var a=this,c=this.auxiliarSectors,d,e,f,g,h;for(h in c)null!=c[h].simulate?d=c[h]:g=c[h];e=a.sectors[d.simulate].delta;f=a.sectors[d.simulate].phi;d.putTogether();d.resizeDelta({anchor:"M",delta:e,callback:function(){d.rotateTo({destination:f})}});g.resizeDelta({anchor:"M",delta:2*Math.PI-e,callback:function(){g.rotateTo({destination:f+e,callback:function(){a.recoverCheesecake()}})}})};socialCheesecake.Cheesecake.prototype.updateActorMembership=
function(a){var c=this._changes,d=!1,e=a.id,f=a.getParentsIds(),g=a.name,a=a.extraInfo,h=this.onChange;if(void 0!=c.actors){var c=c.actors,i;for(i in c)if(c[i].id==e)d=!0,c[i].subsectors=f;d||c.push({id:e,subsectors:f,name:g,extraInfo:a,justAdded:!1})}else c.actors=[],c.actors.push({id:e,subsectors:f,name:g,extraInfo:a,justAdded:!1});h(this)};socialCheesecake.Cheesecake.prototype.calculatePortions=function(){var a=this.sectors,c=this.matchActorsNumber,d=Math.PI/8,e=Math.PI/8,f=5*Math.PI/4-d/2,g=[],
h=[],i=a.length,l=0,j=2*Math.PI;if(a[a.length-1].auxiliar)a[a.length-1].phi=f,a[a.length-1].delta=d,a[a.length-1].originalAttr.phi=a[a.length-1].phi,a[a.length-1].originalAttr.delta=a[a.length-1].delta,f+=d,i=a.length-1,j-=d;for(var d=c?j-i*e:0,k=0;k<i;k++)g[k]=a[k].actors.length,l+=g[k],h[k]=e,c||(h[k]=j/i);for(k=0;k<i;k++)h[k]=0!=l?h[k]+g[k]/l*d:j/i,a[k].phi=f,a[k].delta=h[k],a[k].originalAttr.phi=a[k].phi,a[k].originalAttr.delta=a[k].delta,f+=a[k].delta};socialCheesecake.Cheesecake.prototype.setHighlightedSector=
function(a){if(this.highlightedSector!=a)this.highlightedSector=a,this.highlightedSectorCallback&&this.highlightedSectorCallback(this)};socialCheesecake.Cheesecake.prototype.getSectorById=function(a){var c=this.sectors,d,e;for(e in c)if(c[e].id==a){d=c[e];break}return d};socialCheesecake.Cheesecake.prototype.getSubsectorById=function(a){var c=this.sectors,d,e,f;for(f in c){d=c[f].subsectors;for(var g in d)if(d[g].id==a){e=d[g];break}}return e};socialCheesecake.Cheesecake.prototype.getChanges=function(){return this._changes};
socialCheesecake.Cheesecake.prototype.getInitialState=function(){return this._initialState};socialCheesecake.Cheesecake.prototype._setInitialState=function(){var a=this._initialState,c=this.grid.actors;a.actors=[];for(var d in c)a.actors.push({id:c[d].id,subsectors:c[d].getParentsIds(),name:c[d].name,extraInfo:c[d].extraInfo})};socialCheesecake.Cheesecake.getMaxVisibleActors=function(){return a};socialCheesecake.Cheesecake.setMaxVisibleActors=function(b){"number"===typeof b&&(a=b)}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.Grid=function(a){if(!a)throw"No arguments passed to the function";this.actors=[];this.parent=a.parent;this.id=a.grid_id;this.divIdPrefix=a.divIdPrefix;this.visibleActors=[]};socialCheesecake.Grid.prototype.addActor=function(a,b){var c=this.actors,d=this.visibleActors,e=socialCheesecake.Cheesecake.getMaxVisibleActors(),f,g=!1,h;for(h in c)if(c[h].id==a.id){g=!0;f=c[h];var i=!1,l;for(l in f.parents)f.parents[l]==b&&(i=!0);i||f.parents.push(b)}if(!g)a.parent=b,f=new socialCheesecake.Actor(a),
c.push(f),c.length<=e&&(f.show(),d.push(f));return f};socialCheesecake.Grid.prototype.removeActor=function(a){var b=this.actors,c;for(c in b)b[c].id==a.id&&0>=a.parents.length&&b.splice(c,1)};socialCheesecake.Grid.prototype.getActor=function(a){var b=this.actors,c;for(c in b)if(this.actors[c].id==a)return this.actors[c];return null};socialCheesecake.Grid.prototype.getSelectedActors=function(){var a=this.visibleActors,b=[],c;for(c in a)a[c]&&a[c].isSelected()&&b.push(a[c]);return b};socialCheesecake.Grid.prototype.getShownActors=
function(){return this.visibleActors};socialCheesecake.Grid.prototype.select=function(a){var b;if(a instanceof Array)for(var c in a){if(b=a[c])b instanceof socialCheesecake.Actor||(b=this.getActor(b)),b.select()}else b=a,a instanceof socialCheesecake.Actor||(b=this.getActor(a)),b.select()};socialCheesecake.Grid.prototype.selectAll=function(){this.select(this.visibleActors)};socialCheesecake.Grid.prototype.unselect=function(a){var b;if(a instanceof Array)for(var c in a){if(b=a[c])b instanceof socialCheesecake.Actor||
(b=this.getActor(b)),b.unselect()}else b=a,a instanceof socialCheesecake.Actor||(b=this.getActor(a)),b.unselect()};socialCheesecake.Grid.prototype.unselectAll=function(){this.unselect(this.visibleActors)};socialCheesecake.Grid.prototype.focus=function(a){var b;if(a instanceof Array)for(var c in a){if(b=a[c])b instanceof socialCheesecake.Actor||(b=this.getActor(b)),b.focus()}else b=a,a instanceof socialCheesecake.Actor||(b=this.getActor(a)),b.focus()};socialCheesecake.Grid.prototype.focusAll=function(){this.focus(this.visibleActors)};
socialCheesecake.Grid.prototype.hide=function(a,b){var c,d=this.visibleActors;c=-1;if(a instanceof Array)for(var e in a){if(c=a[e])if(c instanceof socialCheesecake.Actor||(c=this.getActor(c)),!c.isSelected()||b)c.hide(),d[d.indexOf(c)]=!1}else c=a instanceof socialCheesecake.Actor?a:this.getActor(a),c.hide(),d[d.indexOf(c)]=!1;for(c=d.indexOf(!1);0<=c;)d.splice(c,1),c=d.indexOf(!1)};socialCheesecake.Grid.prototype.hideAll=function(){this.hide(this.visibleActors)};socialCheesecake.Grid.prototype.show=
function(a){var b,c=this.visibleActors,d=Math.min(a.length,socialCheesecake.Cheesecake.getMaxVisibleActors());if(a instanceof Array)for(var e=0;c.length<d;e++){if(b=a[e])if(b instanceof socialCheesecake.Actor||(b=this.getActor(b)),!b.isSelected()||ignoreSelected)b.show(),-1==c.indexOf(b)&&c.push(b)}else if(c.length<d&&(b=a instanceof socialCheesecake.Actor?a:this.getActor(a),!b.isSelected()||ignoreSelected))b.show(),-1==c.indexOf(b)&&c.push(b)};socialCheesecake.Grid.prototype.showAll=function(){this.show(this.actors)};
socialCheesecake.Grid.prototype.unfocus=function(a){var b;if(a instanceof Array)for(var c in a){if(b=a[c])b instanceof socialCheesecake.Actor||(b=this.getActor(b)),b.unfocus()}else b=a,a instanceof socialCheesecake.Actor||(b=this.getActor(a)),b.unfocus()};socialCheesecake.Grid.prototype.unfocusAll=function(){this.unfocus(this.visibleActors)};socialCheesecake.Grid.prototype.fadeOut=function(a,b,c,d){var e,f=this.visibleActors;e=-1;if(a instanceof Array)for(var g in a){if(e=a[g])if(e instanceof socialCheesecake.Actor||
(e=this.getActor(e)),!e.isSelected()||d)e.fadeOut(b,c),f[f.indexOf(e)]=!1}else if(e=a instanceof socialCheesecake.Actor?a:this.getActor(a),!e.isSelected()||d)e.fadeOut(b,c),f[f.indexOf(e)]=!1;for(e=f.indexOf(!1);0<=e;)f.splice(e,1),e=f.indexOf(!1)};socialCheesecake.Grid.prototype.fadeOutAll=function(a,b){this.fadeOut(this.visibleActors,a,b)};socialCheesecake.Grid.prototype.fadeIn=function(a,b,c,d){var e,f=this.visibleActors,g=Math.min(a.length,socialCheesecake.Cheesecake.getMaxVisibleActors());if(a instanceof
Array)for(var h=0;f.length<g;h++){if(e=a[h])if(e instanceof socialCheesecake.Actor||(e=this.getActor(e)),!e.isSelected()||d)e.fadeIn(b,c),-1==f.indexOf(e)&&f.push(e)}else if(f.length<g&&(e=a instanceof socialCheesecake.Actor?a:this.getActor(a),!e.isSelected()||d))e.fadeIn(b,c),-1==f.indexOf(e)&&f.push(e)};socialCheesecake.Grid.prototype.fadeInAll=function(a,b){this.fadeIn(this.actors,a,b)}})();socialCheesecake=socialCheesecake||{};(function(){socialCheesecake.SearchEngine=function(a){this.parent=a.parent};socialCheesecake.SearchEngine.prototype.filter=function(a){var b=this.parent.grid.actors,a=RegExp(a.toLowerCase()),c;for(c in b){var d=b[c];d.name.toLowerCase().match(a)?d.unfilter():d.filter()}this.parent.highlightedSector?this.parent.grid.fadeIn(this.parent.highlightedSector.actors,100,!0):this.parent.grid.fadeIn(this.parent.grid.actors,100,!0)}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.Sector=function(a){var b={center:{x:0,y:0},rIn:0,rOut:300,delta:Math.PI/2,phi:0,label:"",color:socialCheesecake.colors.normalSector.background,fontColor:socialCheesecake.colors.normalSector.font,borderColor:socialCheesecake.colors.normalSector.border,mouseover:{color:socialCheesecake.colors.normalSector.hover},mouseout:{color:socialCheesecake.colors.normalSector.background},mouseup:{color:socialCheesecake.colors.normalSector.background},mousedown:{color:socialCheesecake.colors.normalSector.highlight},
auxiliar:!1},c;for(c in b)if(!(c in a)||void 0===a[c])a[c]=b[c];for(a.phi%=2*Math.PI;0>a.phi;)a.phi+=2*Math.PI;if(0>=a.delta||a.delta>2*Math.PI)throw"Delta must be greater than 0 and less than 2*pi";if(a.id)this.id=a.id;this.x=a.center.x;this.y=a.center.y;this.rOut=a.rOut;this.rIn=a.rIn;this.phi=a.phi;this.delta=a.delta;this.label=a.label;this.color=a.color;this.fontColor=a.fontColor;this.borderColor=a.borderColor;this.mouseover=a.mouseover;this.mouseup=a.mouseup;this.mouseout=a.mouseout;this.mousedown=
a.mousedown;this.subsectors=[];this.extraSubsectors=[];this.actors=[];if(null!=a.parent)this.parent=a.parent;if(null!=a.simulate)this.simulate=a.simulate;this.auxiliar=a.auxiliar;if(null!=a.subsectors){b=this.rIn;c=(this.rOut-this.rIn)/a.subsectors.length;for(var d in a.subsectors){var e=b+c,f=new socialCheesecake.Subsector({id:a.subsectors[d].id,label:a.subsectors[d].name,parent:this,x:this.x,y:this.y,phi:this.phi,delta:this.delta,rIn:b,rOut:e,actors:a.subsectors[d].actors,color:socialCheesecake.colors.normalSector.background,
borderColor:socialCheesecake.colors.normalSector.border,fontColor:socialCheesecake.colors.normalSector.font,mouseover:{color:socialCheesecake.colors.normalSector.hover,callback:function(a){document.body.style.cursor="pointer";a.getCheesecake().grid.hideAll();a.getCheesecake().grid.fadeIn(a.actors,300,!0);a.getCheesecake().setHighlightedSector(a);a.getCheesecake().stage.mainLayer.draw()}},mouseout:{color:socialCheesecake.colors.normalSector.background,callback:function(a){document.body.style.cursor=
"default";a.getCheesecake().grid.fadeIn(a.parent.actors,300,!0);a.getCheesecake().setHighlightedSector(a.parent)}},mousedown:{color:socialCheesecake.colors.normalSector.highlight,callback:function(a){var b=a.getCheesecake().grid.getSelectedActors();0<b.length&&a.changeMembership(b)}},mouseup:{color:socialCheesecake.colors.normalSector.background}}),b=e;this.subsectors.push(f)}}this.originalAttr={x:this.x,y:this.y,phi:this.phi,delta:this.delta,rIn:this.rIn,rOut:this.rOut,color:this.color,fontColor:this.fontColor,
borderColor:this.borderColor,label:this.label,mouseover:this.mouseover,mouseout:this.mouseout,mousedown:this.mousedown,mouseup:this.mouseup,simulate:this.simulate,subsectors:this.subsectors,auxiliar:this.auxiliar};this._region=null};socialCheesecake.Sector.prototype._draw=function(a){var b=this.x,c=this.y,d=this.phi,e=this.delta,f=this.rIn,g=this.rOut,h=this.color,i=this.fontColor,l=this.borderColor,j=this.label,k=this.actors;a.restore();a.save();a.beginPath();a.arc(b,c,g,-d,-(d+e),!0);a.lineTo(b+
f*Math.cos(-d-e),c+f*Math.sin(-d-e));a.arc(b,c,f,-(d+e),-d,!1);a.closePath();a.fillStyle=h;a.fill();a.lineWidth=2;a.strokeStyle=l;a.stroke();this.auxiliar&&"+"==j?socialCheesecake.text.addPlusCharacter(a,b,c,0.5*(g-f)+f,d,e,i):this.parent.auxiliar&&"+"==this.parent.label?socialCheesecake.text.writeCurvedText(j,a,b,c,0.7*(g-f)+f,d,e,i,"newStyle"):socialCheesecake.text.writeCurvedText(j,a,b,c,0.7*(g-f)+f,d,e,i);this.auxiliar||socialCheesecake.text.writeCurvedText("("+k.length+")",a,b,c,0.55*(g-f)+f,
d,e,i)};socialCheesecake.Sector.prototype.getRegion=function(){if(null==this._region){var a=this;a._region=new Kinetic.Shape(function(){var b=this.getContext();a._draw(b)});a._region.on("mouseover",function(){a.eventHandler("mouseover")});a._region.on("mouseout",function(){a.eventHandler("mouseout")});a._region.on("mousedown",function(){a.eventHandler("mousedown")});a._region.on("mouseup",function(){a.eventHandler("mouseup")})}return this._region};socialCheesecake.Sector.prototype.eventHandler=function(a){null!=
this[a]&&(null!=this[a].color&&this.changeColor(this[a].color),null!=this[a].callback&&this[a].callback(this))};socialCheesecake.Sector.prototype.getCheesecake=function(){return this.parent};socialCheesecake.Sector.prototype.splitUp=function(){var a=this.getCheesecake(),b=a.stage.mainLayer,c=this.phi,d=this.delta,e=this.rOut,f=this.rIn,g=(null!=this.simulate?a.sectors[this.simulate]:this).subsectors,h=2*g.length+1,i=0.06*(e-f),e=(e-f-(h-g.length)*i)/g.length,l={x:a.center.x,y:a.center.y,delta:d,phi:c,
label:"+",parent:this,auxiliar:!0,color:socialCheesecake.colors.extraSector.background,borderColor:socialCheesecake.colors.extraSector.border,fontColor:socialCheesecake.colors.extraSector.font,mouseover:{color:socialCheesecake.colors.extraSector.hover,callback:function(a){a.resizeWidth({width:1.5*i,anchor:"m",step:1})}},mouseout:{color:socialCheesecake.colors.extraSector.background,callback:function(a){a.resizeWidth({width:i,anchor:"m",step:1,priority:!0})}},mousedown:{color:socialCheesecake.colors.extraSector.highlight},
mouseup:{color:socialCheesecake.colors.extraSector.background}},j;for(j in g)f+=i,g[j].rIn=f,g[j].rOut=f+e,g[j].phi=c,g[j].delta=d,b.add(g[j].getRegion()),f+=e;for(j=f=0;j<h-g.length;j++){if(0==j)var k=new socialCheesecake.Subsector({x:a.center.x,y:a.center.y,rIn:f,rOut:f+i,delta:d,phi:c,label:"+",parent:this,auxiliar:!0,color:socialCheesecake.colors.extraSector.background,borderColor:socialCheesecake.colors.extraSector.border,fontColor:socialCheesecake.colors.extraSector.font,mouseover:{color:socialCheesecake.colors.extraSector.hover,
callback:function(a){a.resizeWidth({width:1.5*i,anchor:"rin",step:1})}},mouseout:{color:socialCheesecake.colors.extraSector.background,callback:function(a){a.resizeWidth({width:i,anchor:"rin",step:1,priority:!0})}},mousedown:{color:socialCheesecake.colors.extraSector.highlight},mouseup:{color:socialCheesecake.colors.extraSector.background}});else l.rIn=f,l.rOut=f+i,k=new socialCheesecake.Subsector(l);b.add(k.getRegion());this.extraSubsectors.push(k);f+=i+e}b.draw()};socialCheesecake.Sector.prototype.putTogether=
function(){for(var a=this.getCheesecake(),b=a.stage.mainLayer,a=(null!=this.simulate?a.sectors[this.simulate]:this).subsectors,c=this.extraSubsectors,d=c.length;0<d;d--)b.remove(c.pop().getRegion());for(d in a)b.remove(a[d].getRegion())};socialCheesecake.Sector.prototype.changeColor=function(a){var b=this.getCheesecake().stage,c=b.mainLayer.getContext();this.color=a;c.restore();c.save();b.draw()};socialCheesecake.Sector.prototype.resizeDelta=function(a){if(!a)throw"No arguments passed to the function";
var b=this,c=b.getCheesecake().stage,d=c.mainLayer.getContext(),e=b.delta,f=b.phi,g=0.05,h=Math.PI/2,i=1,l=!0,j=0;if(a.step)g=a.step;if(a.delta)h=a.delta;if(a.anchor){if("b"==a.anchor.toLowerCase()||"beginning"==a.anchor)i=0;if("m"==a.anchor.toLowerCase()||"middle"==a.anchor)i=0.5;if("e"==a.anchor.toLowerCase()||"end"==a.anchor)i=1}e>h?(e-h<g&&(g=e-h),e-=g,f+=i*g,j=-1):e<h&&(h-e<g&&(g=h-e),e+=g,f-=i*g,j=1);if(a.priority)b.growDelta=j;null!=b.growDelta&&j!=b.growDelta?l=!1:(l=!0,b.growDelta=j);b.delta=
e;b.phi=f;d.restore();d.save();c.draw();l&&Math.round(1E3*e)!=Math.round(1E3*h)?requestAnimFrame(function(){b.resizeDelta(a)}):(b.growDelta=void 0,a.callback&&a.callback())};socialCheesecake.Sector.prototype.resizeWidth=function(a){var b=this,c=b.getCheesecake().stage,d=c.mainLayer.getContext(),e=this.rIn,f=this.rOut,g=f-e,h=0.05,i=g,l=1,j=0,k=!1,m=!0;if(a.step)h=a.step;if(a.width)i=a.width;if(0>i)throw"Width must be greater than or equal to zero";if(a.anchor){if("i"==a.anchor.toLowerCase()||"in"==
a.anchor||"rin"==a.anchor.toLowerCase())l=1;if("m"==a.anchor.toLowerCase()||"middle"==a.anchor)l=0.5;if("o"==a.anchor.toLowerCase()||"out"==a.anchor||"rout"==a.anchor.toLowerCase())l=0}g>i?(g-i<h&&(h=g-i),j=-1):g<i&&(i-g<h&&(h=i-g),j=1);if(a.priority)b.grow=j;null!=b.grow&&j!=b.grow?m=!1:(m=!0,b.grow=j);f+=j*l*h;e-=j*(1-l)*h;g=f-e;0>e||0>f?(console.log("WARNING!! Width cannot change anymore. It has reached it maximum/ minimum level."),k=!0):(b.rOut=f,b.rIn=e,d.restore(),d.save(),c.draw());m&&!k&&
Math.round(1E3*g)!=Math.round(1E3*i)?requestAnimFrame(function(){b.resizeWidth(a)}):(b.grow=void 0,a.callback&&a.callback())};socialCheesecake.Sector.prototype.focus=function(){var a=this.getCheesecake().stage,b=a.mainLayer.getContext();this.rOut=1.05*this.originalAttr.rOut;b.restore();b.save();a.draw()};socialCheesecake.Sector.prototype.unfocus=function(){var a=this.getCheesecake().stage,b=a.mainLayer.getContext();this.rOut=this.originalAttr.rOut;b.restore();b.save();a.draw()};socialCheesecake.Sector.prototype.fan=
function(a,b){var c=Math.PI/5;a&&this.delta>=c||(a?(this.getRegion().moveToTop(),this.resizeDelta({anchor:"m",delta:c,callback:b})):this.resizeDelta({anchor:"m",delta:this.originalAttr.delta,priority:!0,callback:b}))};socialCheesecake.Sector.prototype.rotateTo=function(a){var b=this,c=this.phi,d=this.delta,e=0.05,f=0,g=b.getCheesecake().stage,h=g.mainLayer.getContext();if(!a)throw"No arguments passed to the function";if(a.step)e=a.step;if(null==a.destination)throw"destination must be defined";if(a.anchor){if("b"==
a.anchor.toLowerCase()||"beginning"==a.anchor)f=0;if("m"==a.anchor.toLowerCase()||"middle"==a.anchor)f=0.5;if("e"==a.anchor.toLowerCase()||"end"==a.anchor)f=1}for(d=(a.destination-f*d)%(2*Math.PI);0>d;)d+=2*Math.PI;f=0;d>c?f=1:d<c&&(f=-1);Math.round(1E3*(2*Math.PI-Math.abs(d-c)))/1E3>=Math.round(1E3*Math.abs(d-c))/1E3?(Math.abs(d-c)<e&&(e=Math.abs(d-c)),c+=f*e):(2*Math.PI-Math.abs(d-c)<e&&(e=2*Math.PI-Math.abs(d-c)),d-=2*f*Math.PI,c-=f*e);b.phi=c;h.restore();h.save();g.draw();0.001<Math.abs(c-d)?
(b.phi=c%(2*Math.PI),requestAnimFrame(function(){b.rotateTo({context:h,destination:a.destination,step:e,callback:a.callback,anchor:a.anchor})})):a.callback&&a.callback()};socialCheesecake.Sector.prototype.addActor=function(a,b){var c=this.actors,d,e=!1,f;for(f in c)if(c[f].id==a.id){e=!0;d=c[f];var g=!1,h;for(h in d.parents)d.parents[h]==b&&(g=!0);g||d.parents.push(b)}e||(d=this==b?this.parent.addActor(a,b):this.parent.grid.addActor(a,b),c.push(d));return d};socialCheesecake.Sector.prototype.removeActor=
function(a){var b=this.actors,c,d=!1,e;for(e in b)if(b[e].id==a.id){c=a.parents;for(var f in c)for(var g in this.subsectors)if(c[f]===this.subsectors[g]){d=!0;break}d||b.splice(e,1)}};socialCheesecake.Subsector=function(a){this.id=a.id;if(null!=a.parent)this.parent=a.parent;this.label="";if(null!=a.label)this.label=a.label;this.x=a.x;this.y=a.y;this.rOut=a.rOut;this.rIn=a.rIn;this.phi=a.phi;this.delta=a.delta;this.actors=[];this.auxiliar=a.auxiliar?a.auxiliar:!1;if(a.color)this.color=a.color;if(a.fontColor)this.fontColor=
a.fontColor;if(a.borderColor)this.borderColor=a.borderColor;if(null!=a.mousedown)this.mousedown=a.mousedown;if(null!=a.mouseup)this.mouseup=a.mouseup;if(null!=a.mouseover)this.mouseover=a.mouseover;if(null!=a.mouseout)this.mouseout=a.mouseout;this.getCheesecake();if(a.actors)for(var b in a.actors)this.addActor({id:a.actors[b][0],name:a.actors[b][1],extraInfo:a.actors[b][2]},this)};socialCheesecake.Subsector.prototype=new socialCheesecake.Sector({id:this.id,parent:this.parent,center:{x:this.x,y:this.y},
label:this.label,rIn:this.rIn,rOut:this.rOut,phi:this.phi,delta:this.delta,auxiliar:this.auxiliar,color:this.color,fontColor:this.fontColor,borderColor:this.borderColor,mouseover:this.mouseover,mouseout:this.mouseout,mouseup:this.mouseup,mousedown:this.mousedown});socialCheesecake.Subsector.prototype.getCheesecake=function(){return this.parent.parent};socialCheesecake.Subsector.prototype.removeActor=function(a){var b=this.actors,c,d;for(d in b)if(b[d].id==a.id){c=a.parents;for(var e in c)c[e]===this&&
c.splice(e,1);b.splice(d,1);this.parent.removeActor(a)}};socialCheesecake.Subsector.prototype.changeMembership=function(a){var b=this.actors,c;c=!1;for(var d in a){for(var e in b)if(b[e].id==a[d].id){c=!0;this.removeActor(a[d]);break}c||(c={id:a[d].id},this.addActor(c,this));this.getCheesecake().updateActorMembership(a[d]);c=!1}this.getCheesecake().calculatePortions()}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.text={style:"bold 14px sans-serif",newStyle:"bold 14px sans-serif",addPlusCharacter:function(a,b,c,d,e,f,g,h){a.font=h&&socialCheesecake.text[h]?socialCheesecake.text[h]:socialCheesecake.text.style;a.fillStyle=g||"#000";a.textAlign="center";a.textBaseline="middle";text="+";a.translate(b,c);a.rotate(-f/2-e-Math.PI/2);a.fillText(text[0],0,d);a.restore();a.save()},writeCurvedText:function(a,b,c,d,e,f,g,h,i){b.font=i&&socialCheesecake.text[i]?socialCheesecake.text[i]:socialCheesecake.text.style;
b.fillStyle=h||"#000";b.textBaseline="middle";for(var h=Math.tan(b.measureText(a).width/(a.length*e)),i=null,l=a;h*(a.length+4)>g;){if(i==a){console.log("WARNING: Infinite loop detected and stopped. Text '"+l+"' failed to be correctly truncated. Proccesed serveral times as '"+a+"' and will be returned as '"+words[0].substring(0,g/h-7)+"'. Space too small to even be able to truncate.");a=words[0].substring(0,g/h-7);break}else i=a;words=a.split(" ");1<words.length?(words.splice(words.length-1,1),a=
words.join(" ")+"..."):a=words[0].substring(0,g/h-7)+"...";h=Math.tan(b.measureText(a).width/(a.length*e))}b.translate(c,d);c=0;f+g/2>=Math.PI&&f+g/2<2*Math.PI?(c=-1,b.rotate(-(g-h*a.length)/2-f-Math.PI/2)):(c=1,b.rotate((g-h*a.length)/2+Math.PI/2-g-f));for(f=0;f<a.length;f++)b.fillText(a[f],0,-(c*e)),g=Math.tan(b.measureText(a[f]).width/e),b.rotate(c*g);b.restore();b.save()},writeCenterText:function(a,b,c,d){b.fillText(a,c-b.measureText(a).width/2,d)}}})();
