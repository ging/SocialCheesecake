/*
 SocialCheesecake JavaScript Library v0.1.0
 https://github.com/adiezbal/SocialCheesecake
 Developed by Alicia D?ez (https://github.com/adiezbal)
 Copyright 2011, Technical University of Madrid (Universidad Polit?cnica de Madrid)
 Licensed under the MIT or GPL Version 2 licenses.
 Date: Dec 22 2011

 Copyright (C) 2011 by Technical University of Madrid (Universidad Polit?cnica de Madrid)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
*/
var socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.Actor=function(a){if(!a)throw"No arguments passed to the function";if(!a.parent)throw"Actor must be associated to at least a subsector";var b={},c;for(c in b)c in a||(a[c]=b[c]);this.id=a.id;this.name=a.name;this.opacity=1;this._filtered=this._hidden=this._selected=this._focused=!1;this.fading="none";this.parents=[];a.parent&&this.parents.push(a.parent);var d=this,e=d.getDiv(),f=function(){var a;d.focus();for(var b in d.parents)a=d.parents[b].parent,a.focus(),a.changeColor(a.mouseover.color),
d.parents[b].changeColor(d.parents[b].mouseover.color)},g=function(){var a;d.unfocus();for(var b in d.parents)a=d.parents[b].parent,a.unfocus(),a.changeColor(a.mouseout.color),d.parents[b].changeColor(a.mouseout.color)};e.addEventListener("mouseover",f,!1);e.addEventListener("mouseout",g,!1);e.addEventListener("mousedown",function(){d.isSelected()?(d._selected=!1,d.unfocus(),e.addEventListener("mouseover",f,!1),e.addEventListener("mouseout",g,!1)):(d._selected=!0,d.focus(),e.removeEventListener("mouseover",
f,!1),e.removeEventListener("mouseout",g,!1))})};socialCheesecake.Actor.prototype.isSelected=function(){return this._selected};socialCheesecake.Actor.prototype.focus=function(){var a=this.getDiv(),b="";this._focused=!0;a.getAttribute("class")?a.getAttribute("class").match(/\sfocused/)||(b=a.getAttribute("class").concat(" focused"),a.setAttribute("class",b)):a.setAttribute("class","focused")};socialCheesecake.Actor.prototype.unfocus=function(){var a=this.getDiv(),b="";this._focused=!1;a.getAttribute("class")&&
(b=a.getAttribute("class").replace(/(^|\s)focused($|\s)/,""),a.setAttribute("class",b))};socialCheesecake.Actor.prototype.isFocused=function(){this.getCheesecake();return this._focused};socialCheesecake.Actor.prototype.hide=function(){var a=this.getDiv(),b=" display: none;";this._hidden=!0;a.getAttribute("style")&&(b=a.getAttribute("style").match(/display\s*:\s*[a-z]*;/)?a.getAttribute("style").replace(/display\s*:\s*[a-z]*;/,"display: none;"):a.getAttribute("style").concat("display: none;"));a.setAttribute("style",
b);this.setDivOpacity(0);this.fading="none"};socialCheesecake.Actor.prototype.show=function(){if(!this.isFiltered()){var a=this.getDiv();this._hidden=!1;if(a.getAttribute("style")){var b=a.getAttribute("style").replace(/display\s*:\s*none;/,"");a.setAttribute("style",b)}}};socialCheesecake.Actor.prototype.isHidden=function(){return this._hidden};socialCheesecake.Actor.prototype.isFiltered=function(){return this._filtered};socialCheesecake.Actor.prototype.isVisible=function(){return!(this.isHidden()||
this.isFiltered())};socialCheesecake.Actor.prototype.filter=function(){this._filtered=!0;this.fadeOut(100,!0)};socialCheesecake.Actor.prototype.unfilter=function(){this._filtered=!1};socialCheesecake.Actor.prototype.setDivOpacity=function(a){var a=1<a?1:a,a=0>a?0:a,b=this.getDiv();this.opacity=a;a="opacity: "+this.opacity+";";b.getAttribute("style")&&(a=b.getAttribute("style").replace(/opacity\s*:\s*[a-zA-Z0-9.]*;/g,""),a=a.concat("opacity: "+this.opacity+";"));b.setAttribute("style",a)};socialCheesecake.Actor.prototype.fade=
function(a,b){var c=this,d=1E3/(60*a),e=0;"out"==this.fading?e=-1:"in"==this.fading&&(e=1,b&&c.show());d=this.opacity+e*d;d=Math.round(1E3*d)/1E3;c.setDivOpacity(d);"out"==this.fading&&0<=d||"in"==this.fading&&1>=d?requestAnimFrame(function(){c.fade(a,b)}):(this.fading="none",b&&0>=d&&c.hide())};socialCheesecake.Actor.prototype.fadeOut=function(a,b){this.fading="out";this.fade(a,b)};socialCheesecake.Actor.prototype.fadeIn=function(a,b){if(!this.isFiltered())this.fading="in",this.fade(a,b)};socialCheesecake.Actor.prototype.getCheesecake=
function(){return this.parents[0].parent.parent};socialCheesecake.Actor.prototype.getDiv=function(){var a=this.getCheesecake().grid.divIdPrefix;return document.getElementById(a+this.id)}})();socialCheesecake=socialCheesecake||{};
(function(){var a="#eeffee",b="#77ff77",c="#aaffaa",d="#1F4A75",e="#D4E4EA",f="#1FA0F7",g="#1FA0F7",h="#1F4A75",i="#f5f5f5",j="#f5f5f5",k="#f5f5f5",l="#666";socialCheesecake.Cheesecake=function(a){var b=a.sectors,c=this;c.center={x:a.center.x,y:a.center.y};c.rMax=a.rMax;c.sectors=[];c.highlightedSector=null;c.highlightedSectorCallback=a.highlightedSectorCallback||void 0;c.auxiliarSectors=[];c.stage=new Kinetic.Stage(a.container.id,a.container.width,a.container.height);c.grid=new socialCheesecake.Grid({parent:this,
grid_id:a.grid.id,divIdPrefix:a.grid.divIdPrefix||"actor_"});c.searchEngine=new socialCheesecake.SearchEngine({parent:this});c.matchActorsNumber=a.match||!0;c.changes={};var d=new socialCheesecake.Sector({parent:c,center:{x:a.center.x,y:a.center.y},label:"+",rOut:a.rMax,color:socialCheesecake.Cheesecake.getExtraSectorFillColor(),mouseover:{color:socialCheesecake.Cheesecake.getExtraSectorHoverColor(),callback:function(a){a.focus()}},mouseout:{color:socialCheesecake.Cheesecake.getExtraSectorFillColor(),
callback:function(a){a.unfocus()}},mouseup:{color:socialCheesecake.Cheesecake.getExtraSectorFillColor()},mousedown:{color:socialCheesecake.Cheesecake.getExtraSectorFocusColor()},auxiliar:!0,textAndStrokeColor:socialCheesecake.Cheesecake.getExtraSectorTextAndStrokeColor()});c.sectors[b.length]=d;for(d=0;d<b.length;d++){var e={parent:c,center:{x:a.center.x,y:a.center.y},label:b[d].name,rOut:a.rMax,subsectors:b[d].subsectors,mouseover:{color:socialCheesecake.Cheesecake.getSectorHoverColor(),callback:function(a){for(var b in c.sectors)c.sectors[b].getRegion().removeEventListener("mouseout"),
c.sectors[b]!=a&&(c.sectors[b].unfocus(),c.sectors[b].changeColor(c.sectors[b].mouseout.color));a.getRegion().addEventListener("mouseout",function(){a.eventHandler("mouseout")});document.body.style.cursor="pointer";c.grid.hideAll();c.grid.fadeIn(a.actors,300,!0);a.focus();a.getCheesecake().setHighlightedSector(a)}},mouseout:{color:socialCheesecake.Cheesecake.getSectorFillColor(),callback:function(a){document.body.style.cursor="default";c.grid.fadeInAll(300,!0);a.unfocus();a.getCheesecake().setHighlightedSector(null)}},
mousedown:{color:socialCheesecake.Cheesecake.getSectorFocusColor(),callback:function(a){c.focusAndBlurCheesecake(a);c.grid.hideAll();c.grid.fadeIn(a.actors,300,!0)}},mouseup:{color:socialCheesecake.Cheesecake.getSectorFillColor()},textAndStrokeColor:socialCheesecake.Cheesecake.getSectorTextAndStrokeColor()};c.sectors[d]=new socialCheesecake.Sector(e)}c.calculatePortions();c.draw()};socialCheesecake.Cheesecake.prototype.draw=function(){var a=this.sectors,b;for(b in a)this.stage.add(a[b].getRegion())};
socialCheesecake.Cheesecake.prototype.focusAndBlurCheesecake=function(a){var b=this,c=b.stage.getShapes(),d,e;for(e in b.sectors)b.sectors[e]===a&&(d=e);if(null==d)throw"sector doesn't belong to this cheesecake";for(e=c.length-1;0<=e;e--)c[e].permanent||b.stage.remove(c[e]);this.setHighlightedSector(a);var c={parent:b,center:{x:b.center.x,y:b.center.y},phi:a.phi+a.delta,delta:2*Math.PI-a.delta,rOut:b.rMax,mouseout:{color:socialCheesecake.Cheesecake.getGreySectorFillColor(),callback:function(){document.body.style.cursor=
"default"}},mousedown:{color:socialCheesecake.Cheesecake.getGreySectorFocusColor()},mouseup:{color:socialCheesecake.Cheesecake.getGreySectorFillColor()},mouseover:{color:socialCheesecake.Cheesecake.getGreySectorHoverColor(),callback:function(){document.body.style.cursor="pointer"}},color:socialCheesecake.Cheesecake.getGreySectorFillColor(),textAndStrokeColor:socialCheesecake.Cheesecake.getGreySectorTextAndStrokeColor(),auxiliar:!0},a={parent:b,center:{x:b.center.x,y:b.center.y},phi:a.phi,delta:a.delta,
rOut:a.rOut,label:a.label,simulate:d,mouseout:{callback:function(){document.body.style.cursor="default"}},mouseover:{callback:function(){document.body.style.cursor="pointer"}},auxiliar:!0},g=new socialCheesecake.Sector(c);b.auxiliarSectors.push(g);var f=new socialCheesecake.Sector(a);b.auxiliarSectors.push(f);b.stage.add(g.getRegion());b.stage.add(f.getRegion());var h=function(){g.label="";b.unfocusAndUnblurCheesecake();b.grid.showAll()},i=function(){g.mousedown.callback=h;g.label="GO BACK"},j=function(){f.splitUp()};
g.rotateTo({destination:5*Math.PI/4,callback:function(){g.resizeDelta({delta:3*Math.PI/2,anchor:"M",callback:i})},anchor:"M"});f.rotateTo({destination:Math.PI/4,callback:function(){f.resizeDelta({anchor:"M",callback:j})},anchor:"M"})};socialCheesecake.Cheesecake.prototype.recoverCheesecake=function(){for(var a=this.stage.getShapes(),b=a.length-1;0<=b;b--)a[b].permanent||this.stage.remove(a[b]);this.auxiliarSectors.pop();this.draw();this.grid.fadeInAll(300,!0)};socialCheesecake.Cheesecake.prototype.unfocusAndUnblurCheesecake=
function(){var a=this,b=this.auxiliarSectors,c,d,e,g,f;for(f in b)null!=b[f].simulate?c=b[f]:g=b[f];d=a.sectors[c.simulate].delta;e=a.sectors[c.simulate].phi;this.setHighlightedSector(null);c.putTogether();c.resizeDelta({anchor:"M",delta:d,callback:function(){c.rotateTo({destination:e})}});g.resizeDelta({anchor:"M",delta:2*Math.PI-d,callback:function(){g.rotateTo({destination:e+d,callback:function(){a.recoverCheesecake()}})}})};socialCheesecake.Cheesecake.prototype.updateActorMembership=function(a){var b=
this.changes,c=!1,d=this.grid.getActor(a).parents,e=[],g;for(g in d)e.push(d[g].id);if(void 0!=b.actors){var b=b.actors,f;for(f in b)if(b[f].id==a)c=!0,b[f].subsectors=e;c||b.push({id:a,subsectors:e})}else b.actors=[],b.actors.push({id:a,subsectors:e})};socialCheesecake.Cheesecake.prototype.calculatePortions=function(){var a=this.sectors,b=this.matchActorsNumber,c=Math.PI/8,d,e=Math.PI/6,g=5*Math.PI/4-c/2,f,h=d=0,i=0,j=[];a[a.length-1].phi=g;a[a.length-1].delta=c;a[a.length-1].originalAttr.phi=a[a.length-
1].phi;a[a.length-1].originalAttr.delta=a[a.length-1].delta;g+=c;0==this.grid.actors.length&&(b=!1);if(b){for(b=0;b<a.length-1;b++)d+=a[b].actors.length;h=d;for(b=0;b<a.length-1;b++)f=a[b].actors.length,0.1>=f/d&&(j[b]=!0,i++,h-=a[b].actors.length);for(b=0;b<a.length-1;b++)d=j[b]?e:a[b].actors.length/h*(2*Math.PI-c-i*e),a[b].phi=g,a[b].delta=d,a[b].originalAttr.phi=a[b].phi,a[b].originalAttr.delta=a[b].delta,g+=d}else{d=(2*Math.PI-c)/(a.length-1);for(b=0;b<a.length-1;b++)a[b].phi=g,a[b].delta=d,a[b].originalAttr.phi=
a[b].phi,a[b].originalAttr.delta=a[b].delta,g+=d}};socialCheesecake.Cheesecake.prototype.setHighlightedSector=function(a){if(this.highlightedSector!=a)this.highlightedSector=a,this.highlightedSectorCallback&&this.highlightedSectorCallback(this)};socialCheesecake.Cheesecake.prototype.getChanges=function(){return this.changes};socialCheesecake.Cheesecake.prototype.fanInSector=function(a,b){var c=this.sectors,d=Math.PI/5,e=0,g=0,f=0;if(!(b&&a.delta>=d)){for(f=0;f<c.length;f++)c[f]===a&&(e=f-1,g=f+1);
0>e&&(e=c.length-1);g>=c.length&&(g=0);b?(f=(d-a.delta)/2,a.resizeDelta({anchor:"m",delta:d}),console.log("delta to change "+f),console.log("delta of prev "+c[e].delta),console.log("delta of later "+c[g].delta),c[e].resizeDelta({anchor:"b",delta:c[e].delta-f}),c[g].resizeDelta({anchor:"e",delta:c[g].delta-f})):(a.resizeDelta({anchor:"m",delta:a.originalAttr.delta}),c[e].resizeDelta({anchor:"b",delta:c[e].originalAttr.delta}),c[g].resizeDelta({anchor:"e",delta:c[g].originalAttr.delta}))}};socialCheesecake.Cheesecake.getSectorFillColor=
function(){return a};socialCheesecake.Cheesecake.setSectorFillColor=function(b){"string"===typeof b&&(a=b)};socialCheesecake.Cheesecake.getExtraSectorFillColor=function(){return e};socialCheesecake.Cheesecake.setExtraSectorFillColor=function(a){"string"===typeof a&&(e=a)};socialCheesecake.Cheesecake.getGreySectorFillColor=function(){return i};socialCheesecake.Cheesecake.setGreySectorFillColor=function(a){"string"===typeof a&&(i=a)};socialCheesecake.Cheesecake.getSectorFocusColor=function(){return b};
socialCheesecake.Cheesecake.setSectorFocusColor=function(a){"string"===typeof a&&(b=a)};socialCheesecake.Cheesecake.getExtraSectorFocusColor=function(){return f};socialCheesecake.Cheesecake.setExtraSectorFocusColor=function(a){"string"===typeof a&&(f=a)};socialCheesecake.Cheesecake.getGreySectorFocusColor=function(){return j};socialCheesecake.Cheesecake.setGreySectorFocusColor=function(a){"string"===typeof a&&(j=a)};socialCheesecake.Cheesecake.getSectorHoverColor=function(){return c};socialCheesecake.Cheesecake.setSectorHoverColor=
function(a){"string"===typeof a&&(c=a)};socialCheesecake.Cheesecake.getExtraSectorHoverColor=function(){return g};socialCheesecake.Cheesecake.setExtraSectorHoverColor=function(a){"string"===typeof a&&(g=a)};socialCheesecake.Cheesecake.getGreySectorHoverColor=function(){return k};socialCheesecake.Cheesecake.setGreySectorHoverColor=function(a){"string"===typeof a&&(k=a)};socialCheesecake.Cheesecake.getSectorTextAndStrokeColor=function(){return d};socialCheesecake.Cheesecake.setSectorTextAndStrokeColor=
function(a){"string"===typeof a&&(d=a)};socialCheesecake.Cheesecake.getExtraSectorTextAndStrokeColor=function(){return h};socialCheesecake.Cheesecake.setExtraSectorTextAndStrokeColor=function(a){"string"===typeof a&&(h=a)};socialCheesecake.Cheesecake.getGreySectorTextAndStrokeColor=function(){return l};socialCheesecake.Cheesecake.setGreySectorTextAndStrokeColor=function(a){"string"===typeof a&&(l=a)}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.Grid=function(a){if(!a)throw"No arguments passed to the function";this.actors=[];this.parent=a.parent;this.id=a.grid_id;this.divIdPrefix=a.divIdPrefix};socialCheesecake.Grid.prototype.addActor=function(a,b){var c=this.actors,d,e=!1,f;for(f in c)if(c[f].id==a.id){e=!0;d=c[f];var g=!1,h;for(h in d.parents)d.parents[h]==b&&(g=!0);g||d.parents.push(b)}if(!e)a.parent=b,d=new socialCheesecake.Actor(a),c.push(d);return d};socialCheesecake.Grid.prototype.removeActor=function(a){var b=
this.actors,c;for(c in b)b[c].id==a.id&&0>=a.parents.length&&b.splice(c,1)};socialCheesecake.Grid.prototype.getActor=function(a){var b=this.actors,c;for(c in b)if(this.actors[c].id==a)return this.actors[c];return null};socialCheesecake.Grid.prototype.getSelectedActors=function(){var a=this.actors,b=[],c;for(c in a)a[c].isSelected()&&b.push(a[c]);return b};socialCheesecake.Grid.prototype.getShownActors=function(){var a=this.actors,b=[],c;for(c in a)!a[c].isHidden()&&!a[c].isFiltered()&&b.push(a[c]);
return b};socialCheesecake.Grid.prototype.focus=function(a){if(a instanceof Array)for(var b in a){var c=a[b];c instanceof socialCheesecake.Actor?c.focus():this.getActor(c).focus()}else a instanceof socialCheesecake.Actor?a.focus():this.getActor(a).focus()};socialCheesecake.Grid.prototype.focusAll=function(){this.focus(this.actors)};socialCheesecake.Grid.prototype.hide=function(a,b){var c;if(a instanceof Array)for(var d in a)c=a[d],c instanceof socialCheesecake.Actor||(c=this.getActor(c)),(!c.isSelected()||
b)&&c.hide();else c=a instanceof socialCheesecake.Actor?a:this.getActor(a),c.hide()};socialCheesecake.Grid.prototype.hideAll=function(){this.hide(this.actors)};socialCheesecake.Grid.prototype.show=function(a){if(a instanceof Array)for(var b in a){var c=a[b];c instanceof socialCheesecake.Actor?c.show():this.getActor(c).show()}else a instanceof socialCheesecake.Actor?a.show():this.getActor(a).show()};socialCheesecake.Grid.prototype.showAll=function(){this.show(this.actors)};socialCheesecake.Grid.prototype.unfocus=
function(a){if(a instanceof Array)for(var b in a){var c=a[b];c instanceof socialCheesecake.Actor?c.unfocus():this.getActor(c).unfocus()}else a instanceof socialCheesecake.Actor?a.unfocus():this.getActor(a).unfocus()};socialCheesecake.Grid.prototype.unfocusAll=function(){this.unfocus(this.actors)};socialCheesecake.Grid.prototype.fadeOut=function(a,b,c,d){var e;if(a instanceof Array)for(var f in a)e=a[f],e instanceof socialCheesecake.Actor||(e=this.getActor(e)),(!e.isSelected()||d)&&e.fadeOut(b,c);
else e=a instanceof socialCheesecake.Actor?a:this.getActor(a),(!e.isSelected()||d)&&e.fadeOut(b,c)};socialCheesecake.Grid.prototype.fadeOutAll=function(a,b){this.fadeOut(this.actors,a,b)};socialCheesecake.Grid.prototype.fadeIn=function(a,b,c,d){var e;if(a instanceof Array)for(var f in a)e=a[f],e instanceof socialCheesecake.Actor||(e=this.getActor(e)),(!e.isSelected()||d)&&e.fadeIn(b,c);else e=a instanceof socialCheesecake.Actor?a:this.getActor(a),(!e.isSelected()||d)&&e.fadeIn(b,c)};socialCheesecake.Grid.prototype.fadeInAll=
function(a,b){this.fadeIn(this.actors,a,b)}})();socialCheesecake=socialCheesecake||{};(function(){socialCheesecake.SearchEngine=function(a){this.parent=a.parent};socialCheesecake.SearchEngine.prototype.filter=function(a){var b=this.parent.grid.actors,a=RegExp(a.toLowerCase()),c;for(c in b){var d=b[c];d.name.toLowerCase().match(a)?d.unfilter():d.filter()}this.parent.highlightedSector?this.parent.grid.fadeIn(this.parent.highlightedSector.actors,100,!0):this.parent.grid.fadeIn(this.parent.grid.actors,100,!0)}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.Sector=function(a){var b={center:{x:0,y:0},rIn:0,rOut:300,delta:Math.PI/2,phi:0,label:"",color:socialCheesecake.Cheesecake.getSectorFillColor(),textAndStrokeColor:socialCheesecake.Cheesecake.getSectorTextAndStrokeColor(),mouseover:{color:socialCheesecake.Cheesecake.getSectorHoverColor()},mouseout:{color:socialCheesecake.Cheesecake.getSectorFillColor()},mouseup:{color:socialCheesecake.Cheesecake.getSectorFillColor()},mousedown:{color:socialCheesecake.Cheesecake.getSectorFocusColor()},auxiliar:!1},
c;for(c in b)if(!(c in a)||void 0===a[c])a[c]=b[c];for(a.phi%=2*Math.PI;0>a.phi;)a.phi+=2*Math.PI;if(0>=a.delta||a.delta>2*Math.PI)throw"Delta must be greater than 0 and less than 2*pi";if(a.id)this.id=a.id;this.x=a.center.x;this.y=a.center.y;this.rOut=a.rOut;this.rIn=a.rIn;this.phi=a.phi;this.delta=a.delta;this.label=a.label;this.color=a.color;this.textAndStrokeColor=a.textAndStrokeColor;this.mouseover=a.mouseover;this.mouseup=a.mouseup;this.mouseout=a.mouseout;this.mousedown=a.mousedown;this.subsectors=
[];this.extraSubsectors=[];this.actors=[];if(null!=a.parent)this.parent=a.parent;if(null!=a.simulate)this.simulate=a.simulate;this.auxiliar=a.auxiliar;if(null!=a.subsectors){b=this.rIn;c=(this.rOut-this.rIn)/a.subsectors.length;for(var d in a.subsectors){var e=b+c,f=new socialCheesecake.Subsector({id:a.subsectors[d].id,label:a.subsectors[d].name,parent:this,x:this.x,y:this.y,phi:this.phi,delta:this.delta,rIn:b,rOut:e,actors:a.subsectors[d].actors,mouseover:{color:socialCheesecake.Cheesecake.getSectorHoverColor(),
callback:function(a){for(var b in a.parent.subsectors)a.parent.subsectors[b].getRegion().removeEventListener("mouseout"),a.parent.subsectors[b]!=a&&a.parent.subsectors[b].changeColor(a.parent.subsectors[b].mouseout.color);a.getRegion().addEventListener("mouseout",function(){a.eventHandler("mouseout")});document.body.style.cursor="pointer";a.getCheesecake().grid.hideAll();a.getCheesecake().grid.fadeIn(a.actors,300,!0);a.getCheesecake().setHighlightedSector(a)}},mouseout:{color:socialCheesecake.Cheesecake.getSectorFillColor(),
callback:function(a){document.body.style.cursor="default";a.getCheesecake().grid.fadeIn(a.parent.actors,300,!0);a.getCheesecake().setHighlightedSector(a.parent)}},mousedown:{callback:function(a){var b=a.getCheesecake().grid.getSelectedActors();a.changeMembership(b)}}}),b=e;this.subsectors.push(f)}}this.originalAttr={x:this.x,y:this.y,phi:this.phi,delta:this.delta,rIn:this.rIn,rOut:this.rOut,color:this.color,textAndStrokeColor:this.textAndStrokeColor,label:this.label,mouseover:this.mouseover,mouseout:this.mouseout,
mousedown:this.mousedown,mouseup:this.mouseup,simulate:this.simulate,subsectors:this.subsectors,auxiliar:this.auxiliar};this._region=null};socialCheesecake.Sector.prototype._draw=function(a){var b=this.x,c=this.y,d=this.phi,e=this.delta,f=this.rIn,g=this.rOut,h=this.color,i=this.textAndStrokeColor,j=this.label,k=this.actors;a.restore();a.save();a.beginPath();a.arc(b,c,g,-d,-(d+e),!0);a.lineTo(b+f*Math.cos(-d-e),c+f*Math.sin(-d-e));a.arc(b,c,f,-(d+e),-d,!1);a.closePath();a.fillStyle=h;a.fill();a.lineWidth=
2;a.strokeStyle=i;a.stroke();this.auxiliar&&"+"==j?socialCheesecake.text.addPlusCharacter(a,b,c,0.5*(g-f)+f,d,e,i):socialCheesecake.text.writeCurvedText(j,a,b,c,0.7*(g-f)+f,d,e,i);this.auxiliar||socialCheesecake.text.writeCurvedText("("+k.length+")",a,b,c,0.55*(g-f)+f,d,e,i)};socialCheesecake.Sector.prototype.getRegion=function(){if(null==this._region){var a=this;a._region=new Kinetic.Shape(function(){var b=this.getContext();a._draw(b)});a._region.addEventListener("mouseover",function(){a.eventHandler("mouseover")});
a._region.addEventListener("mouseout",function(){a.eventHandler("mouseout")});a._region.addEventListener("mousedown",function(){a.eventHandler("mousedown")});a._region.addEventListener("mouseup",function(){a.eventHandler("mouseup")})}return this._region};socialCheesecake.Sector.prototype.eventHandler=function(a){null!=this[a]&&(null!=this[a].color&&this.changeColor(this[a].color),null!=this[a].callback&&this[a].callback(this))};socialCheesecake.Sector.prototype.getCheesecake=function(){return this.parent};
socialCheesecake.Sector.prototype.splitUp=function(){var a=this.getCheesecake(),b=this.phi,c=this.delta,d=this.rOut,e=this.rIn,f=(null!=this.simulate?a.sectors[this.simulate]:this).subsectors,g=2*f.length+1,h=0.06*(d-e),d=(d-e-(g-f.length)*h)/f.length,i={x:a.center.x,y:a.center.y,delta:c,phi:b,label:"+",parent:this,auxiliar:!0,color:socialCheesecake.Cheesecake.getExtraSectorFillColor(),mouseover:{color:socialCheesecake.Cheesecake.getExtraSectorHoverColor(),callback:function(a){a.resizeWidth({width:1.5*
h,anchor:"m",step:1})}},mouseout:{color:socialCheesecake.Cheesecake.getExtraSectorFillColor(),callback:function(a){a.resizeWidth({width:h,anchor:"m",step:1,priority:!0})}}},j;for(j in f)e+=h,f[j].rIn=e,f[j].rOut=e+d,f[j].phi=b,f[j].delta=c,a.stage.add(f[j].getRegion()),e+=d;for(j=e=0;j<g-f.length;j++){if(0==j)var k={x:a.center.x,y:a.center.y,rIn:e,rOut:e+h,delta:c,phi:b,label:"+",parent:this,auxiliar:!0,color:socialCheesecake.Cheesecake.getExtraSectorFillColor(),mouseover:{color:socialCheesecake.Cheesecake.getExtraSectorHoverColor(),
callback:function(a){a.resizeWidth({width:1.5*h,anchor:"rin",step:1})}},mouseout:{color:socialCheesecake.Cheesecake.getExtraSectorFillColor(),callback:function(a){a.resizeWidth({width:h,anchor:"rin",step:1,priority:!0})}}},k=new socialCheesecake.Subsector(k);else i.rIn=e,i.rOut=e+h,k=new socialCheesecake.Subsector(i);a.stage.add(k.getRegion());this.extraSubsectors.push(k);e+=h+d}};socialCheesecake.Sector.prototype.putTogether=function(){for(var a=this.getCheesecake(),b=(null!=this.simulate?a.sectors[this.simulate]:
this).subsectors,c=this.extraSubsectors,d=c.length;0<d;d--)a.stage.remove(c.pop().getRegion());for(d in b)a.stage.remove(b[d].getRegion())};socialCheesecake.Sector.prototype.changeColor=function(a){if(this.getRegion().layer){var b=this.getRegion().layer.getContext(),c=this.getCheesecake().stage;this.color=a;b.restore();b.save();c.draw()}};socialCheesecake.Sector.prototype.resizeDelta=function(a){if(!a)throw"No arguments passed to the function";var b=this,c=b.getRegion().layer.getContext(),d=b.getCheesecake().stage,
e=b.delta,f=b.phi,g=0.05,h=Math.PI/2,i=1;if(a.step)g=a.step;if(a.delta)h=a.delta;console.log("resizing delta of sector "+b.label);console.log("current delta "+e);console.log("delta to achieve "+h);if(a.anchor){if("b"==a.anchor.toLowerCase()||"beginning"==a.anchor)i=0;if("m"==a.anchor.toLowerCase()||"middle"==a.anchor)i=0.5;if("e"==a.anchor.toLowerCase()||"end"==a.anchor)i=1}e>h?(e-h<g&&(g=e-h),e-=g,f+=i*g):e<h&&(h-e<g&&(g=h-e),e+=g,f-=i*g);b.delta=e;b.phi=f;c.restore();c.save();d.draw();e!=h?requestAnimFrame(function(){b.resizeDelta(a)}):
a.callback&&a.callback()};socialCheesecake.Sector.prototype.resizeWidth=function(a){var b=this,c=b.getRegion().layer.getContext(),d=b.getCheesecake().stage,e=this.rIn,f=this.rOut,g=f-e,h=0.05,i=g,j=1,k=0,l=!1,m=!0;if(a.step)h=a.step;if(a.width)i=a.width;if(0>i)throw"Width must be greater than or equal to zero";if(a.anchor){if("i"==a.anchor.toLowerCase()||"in"==a.anchor||"rin"==a.anchor.toLowerCase())j=1;if("m"==a.anchor.toLowerCase()||"middle"==a.anchor)j=0.5;if("o"==a.anchor.toLowerCase()||"out"==
a.anchor||"rout"==a.anchor.toLowerCase())j=0}g>i?(g-i<h&&(h=g-i),k=-1):g<i&&(i-g<h&&(h=i-g),k=1);if(a.priority)b.grow=k;null!=b.grow&&k!=b.grow?m=!1:(m=!0,b.grow=k);f+=k*j*h;e-=k*(1-j)*h;g=f-e;0>e||0>f?(console.log("WARNING!! Width cannot change anymore. It has reached it maximum/ minimum level."),l=!0):(b.rOut=f,b.rIn=e,c.restore(),c.save(),d.draw());m&&!l&&Math.round(1E3*g)!=Math.round(1E3*i)?requestAnimFrame(function(){b.resizeWidth(a)}):(b.grow=void 0,a.callback&&a.callback())};socialCheesecake.Sector.prototype.focus=
function(){var a=this.getRegion().layer.getContext(),b=this.getCheesecake().stage;this.rOut=1.05*this.originalAttr.rOut;a.restore();a.save();b.draw()};socialCheesecake.Sector.prototype.unfocus=function(){var a=this.getRegion().layer.getContext(),b=this.getCheesecake().stage;this.rOut=this.originalAttr.rOut;a.restore();a.save();b.draw()};socialCheesecake.Sector.prototype.rotateTo=function(a){var b=this,c=this.phi,d=this.delta,e=0.05,f=0,g=b.getCheesecake().stage,h=b.getRegion().layer.getContext();
if(!a)throw"No arguments passed to the function";if(a.step)e=a.step;if(null==a.destination)throw"destination must be defined";if(a.anchor){if("b"==a.anchor.toLowerCase()||"beginning"==a.anchor)f=0;if("m"==a.anchor.toLowerCase()||"middle"==a.anchor)f=0.5;if("e"==a.anchor.toLowerCase()||"end"==a.anchor)f=1}for(d=(a.destination-f*d)%(2*Math.PI);0>d;)d+=2*Math.PI;f=0;d>c?f=1:d<c&&(f=-1);Math.round(1E3*(2*Math.PI-Math.abs(d-c)))/1E3>=Math.round(1E3*Math.abs(d-c))/1E3?(Math.abs(d-c)<e&&(e=Math.abs(d-c)),
c+=f*e):(2*Math.PI-Math.abs(d-c)<e&&(e=2*Math.PI-Math.abs(d-c)),d-=2*f*Math.PI,c-=f*e);b.phi=c;h.restore();h.save();g.draw();0.0010<Math.abs(c-d)?(b.phi=c%(2*Math.PI),requestAnimFrame(function(){b.rotateTo({context:h,destination:a.destination,step:e,callback:a.callback,anchor:a.anchor})})):a.callback&&a.callback()};socialCheesecake.Sector.prototype.addActor=function(a,b){var c=this.actors,d,e=!1,f;for(f in c)if(c[f].id==a.id){e=!0;d=c[f];var g=!1,h;for(h in d.parents)d.parents[h]==b&&(g=!0);g||d.parents.push(b)}e||
(d=this==b?this.parent.addActor(a,b):this.parent.grid.addActor(a,b),c.push(d));return d};socialCheesecake.Sector.prototype.removeActor=function(a){var b=this.actors,c,d=!1,e;for(e in b)if(b[e].id==a.id){c=a.parents;for(var f in c)for(var g in this.subsectors)if(c[f]===this.subsectors[g]){d=!0;break}d||b.splice(e,1)}};socialCheesecake.Subsector=function(a){this.id=a.id;if(null!=a.parent)this.parent=a.parent;this.label="";if(null!=a.label)this.label=a.label;this.x=a.x;this.y=a.y;this.rOut=a.rOut;this.rIn=
a.rIn;this.phi=a.phi;this.delta=a.delta;this.actors=[];this.auxiliar=a.auxiliar?a.auxiliar:!1;if(a.color)this.color=a.color;if(a.textAndStrokeColor)this.textAndStrokeColor=a.textAndStrokeColor;if(null!=a.mousedown)this.mousedown=a.mousedown;if(null!=a.mouseup)this.mouseup=a.mouseup;if(null!=a.mouseover)this.mouseover=a.mouseover;if(null!=a.mouseout)this.mouseout=a.mouseout;this.getCheesecake();if(a.actors)for(var b in a.actors)this.addActor({id:a.actors[b][0],name:a.actors[b][1]},this)};socialCheesecake.Subsector.prototype=
new socialCheesecake.Sector({id:this.id,parent:this.parent,center:{x:this.x,y:this.y},label:this.label,rIn:this.rIn,rOut:this.rOut,phi:this.phi,delta:this.delta,auxiliar:this.auxiliar,color:this.color,textAndStrokeColor:this.textAndStrokeColor,mouseover:this.mouseover,mouseout:this.mouseout,mouseup:this.mouseup,mousedown:this.mousedown});socialCheesecake.Subsector.prototype.getCheesecake=function(){return this.parent.parent};socialCheesecake.Subsector.prototype.removeActor=function(a){var b=this.actors,
c,d;for(d in b)if(b[d].id==a.id){c=a.parents;for(var e in c)c[e]===this&&c.splice(e,1);b.splice(d,1);this.parent.removeActor(a)}};socialCheesecake.Subsector.prototype.changeMembership=function(a){var b=this.actors,c;c=!1;for(var d in a){for(var e in b)if(b[e].id==a[d].id){c=!0;this.removeActor(a[d]);break}c||(c={id:a[d].id},this.addActor(c,this));this.getCheesecake().updateActorMembership(a[d].id);c=!1}this.getCheesecake().calculatePortions()}})();socialCheesecake=socialCheesecake||{};
(function(){socialCheesecake.text={addPlusCharacter:function(a,b,c,d,e,f,g){a.font="bold 14px sans-serif";a.fillStyle=g||"#000";a.textAlign="center";a.textBaseline="middle";text="+";a.translate(b,c);a.rotate(-f/2-e-Math.PI/2);a.fillText(text[0],0,d);a.restore();a.save()},writeCurvedText:function(a,b,c,d,e,f,g,h){b.font="bold 14px sans-serif";b.fillStyle=h||"#000";b.textBaseline="middle";for(var h=Math.tan(b.measureText(a).width/(a.length*e)),i=null,j=a;h*(a.length+4)>g;){if(i==a){console.log("WARNING: Infinite loop detected and stopped. Text '"+
j+"' failed to be correctly truncated. Proccesed serveral times as '"+a+"' and will be returned as '"+words[0].substring(0,g/h-7)+"'. Space too small to even be able to truncate.");a=words[0].substring(0,g/h-7);break}else i=a;words=a.split(" ");1<words.length?(words.splice(words.length-1,1),a=words.join(" ")+"..."):a=words[0].substring(0,g/h-7)+"...";h=Math.tan(b.measureText(a).width/(a.length*e))}b.translate(c,d);c=0;f+g/2>=Math.PI&&f+g/2<2*Math.PI?(c=-1,b.rotate(-(g-h*a.length)/2-f-Math.PI/2)):
(c=1,b.rotate((g-h*a.length)/2+Math.PI/2-g-f));for(f=0;f<a.length;f++)b.fillText(a[f],0,-(c*e)),g=Math.tan(b.measureText(a[f]).width/e),b.rotate(c*g);b.restore();b.save()},writeCenterText:function(a,b,c,d){b.fillText(a,c-b.measureText(a).width/2,d)}}})();
