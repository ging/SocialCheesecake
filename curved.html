<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Function for writting curved text</title>
    <style type="text/css">
      #cnv{
        border: 1px solid black;
      }
      .label{
        min-width: 80px;
      }
      .label, .field{
        display: inline-block;
      }
      .row{
        display: block;
      }
    </style>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.min.js"></script>
    <script type="text/javascript" charset="utf-8">
      //PARA LA DEMO
      window.onload= function(){
        setCanvas();
      }
      function setCanvas(){
        cnv = document.getElementById("cnv");
        cnv.width = 800;
        cnv.height = 500;

        aux = document.getElementById("aux");
        aux.width = 500;
        aux.height = 5;
      }
      function drawRadio(){
        ctx = aux.getContext("2d");
        ctx.clearRect(0,0, aux.width, aux.height);
        ctx.moveTo(0, 0);
        ctx.lineTo($('#radio').val(), 0);
        ctx.stroke();
        ctx.closePath();
      }
      function drawAxis(x,y){
        ctx = cnv.getContext("2d");
        ctx.strokeStyle='red';
        ctx.beginPath();
        ctx.arc(x,y, 2, 0, 2*Math.PI, false);
        ctx.stroke();
        ctx.closePath();
      }
      function eraseCanvas(){
        $('#cnv').remove();
        $('#cnv_container').append('<canvas id="cnv"></canvas>');
        $('#aux').remove();
        $('#aux_container').append('<canvas id="aux"></canvas>');
        setCanvas();
        $('#comments').empty();
      }
      function translateAngle(alpha){
        return alpha* Math.PI / 180;
      }
      function transformText(){
        drawRadio();
        var result= curvText($('#text').val(), $('#x').val(), $('#y').val(), 
                    $('#radio').val(), translateAngle($('#phi0').val()), 
                    translateAngle($('#delta_phi').val()));
        writeComment(result);
      }
      function writeComment(text){
        $('#comments').append('<div>'+text+'</div>');
      }
      //NECESARIAS
      /**
      * text: text to curve
      * (x,y): arc axis
      * r: radio
      * phi0: initial angle offset
      */
      function curvText(text, x, y, r, phi0, delta){
        //OJO... TRAZAS!!
        drawAxis(x,y);
        writeComment('Longitud del texto: '+ text.length);
        writeComment('Amplitud: '+ delta);
        
        ctx = cnv.getContext("2d");
        //No se puede poner en el css el estilo del context.
        ctx.font = "bold 12px sans-serif";
        medium_alpha= Math.tan(ctx.measureText(text).width/(text.length *r));
        
        writeComment('Ángulo medio entre letras: '+ medium_alpha);
        writeComment('Amplitud necesaria: '+ medium_alpha*text.length);
        writeComment('Ángulo para centrar: ' + (delta-(medium_alpha*text.length))/2);
        writeComment('Alineación de la fuente: ' + ctx.textBaseline);

        //Comprobar si cabe el texto
        if(medium_alpha*text.length <= delta){
          ctx.translate(x,y);
          var orientation= 0;
          
          if((phi0 + delta/2 > Math.PI ) && (phi0 + delta/2 < Math.PI *2)){
            writeComment('Letras al reves! ángulo medio '+ (phi0 + delta)/2 );
            orientation=-1;
            ctx.rotate(-(delta-(medium_alpha*text.length))/2  - phi0- Math.PI/2);
            //ctx.translate(0, -r);
           
          }else{
            orientation=1;
            ctx.rotate((delta-(medium_alpha*text.length))/2 + Math.PI/2 - delta - phi0);
            //ctx.translate(0, -r);

          }
           for (i = 0; i < text.length; i++) {
            
              ctx.beginPath();       
              ctx.rect(0,0,500, 300);
              ctx.strokeStyle = "#"+i+"0"+i;
              ctx.stroke();
              
              //Indicar coordenadas de dónde empieza el texto.
              //Tener en cuenta el tamaño de la fuente utilizada o se saldrá del canvas!
              ctx.fillText(text[i], 0, -(orientation*r));
              //Fija el ángulo de inclinación entre letras
              var alpha= Math.tan(ctx.measureText(text[i]).width/r);
              console.log('Letra número '+i+' gira un ángulo de '+ alpha);
              ctx.rotate(orientation*alpha);
              //ctx.translate(r*Math.sin(alpha), r*(Math.cos(alpha) - 1));
            }
          return true;
        }
        else{
          return false;
        }
      }
    </script>
  </head>
  <body>
    <div id="cnv_container">
      <canvas id="cnv"></canvas>
    </div>
    <div class="info">
      <div class="row">
        <div class="label">Text:</div>
        <div class="field">
          <input type="text" id="text" value="HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH">
        </div>
      </div>
      <div class="row">
        <div class="label">Axis:</div>
      </div>
      <div class="row">
        <div class="label">
          <div>x</div>
          <div>y</div>
        </div>
        <div class="field">
          <input type="text" id="x" value="400"></br>
          <input type="text" id="y" value="250">
        </div>
      </div>
      <div class="row">
        <div class="label">Radio:</div>
        <div class="field">
          <input type="text" id="radio" value="50">
        </div>
      </div>
      <div class="row">
        <div class="label">Initial angle:</div>
        <div class="field">
          <input type="text" id="phi0" value="0">
        </div>
      </div>
      <div class="row">
        <div class="label">Amplitude:</div>
        <div class="field">
          <input type="text" id="delta_phi" value="360">
        </div>
      </div>
      <div class="row">
        <input type="button" value="Rotate!" onclick="transformText()">
        <input type="button" value="Reset!" onclick="eraseCanvas()">
      </div>
    </div>
    <div id="aux_container">
      <canvas id="aux"></canvas>
    </div>
    <div id="comments">
    </div>
  </body>
</html>
